<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VocabSheet - 英単語帳</title>
    <!-- 必要なライブラリの読み込み -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-50">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // エラーの原因となる外部ライブラリ依存を無くすため、アイコンをSVGで定義
        const Icon = ({ name, className = "" }) => {
            const icons = {
                "refresh-cw": <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/></svg>,
                "list": <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></svg>,
                "plus": <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>,
                "brain": <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M9.5 2A2.5 2.5 0 0 1 12 4.5v15a2.5 2.5 0 0 1-4.96.44 2.5 2.5 0 0 1-2.96-3.08 3 3 0 0 1-.34-5.58 2.5 2.5 0 0 1 1.32-4.24 2.5 2.5 0 0 1 4.44-2.04Z"/><path d="M14.5 2A2.5 2.5 0 0 0 12 4.5v15a2.5 2.5 0 0 0 4.96.44 2.5 2.5 0 0 0 2.96-3.08 3 3 0 0 0 .34-5.58 2.5 2.5 0 0 0-1.32-4.24 2.5 2.5 0 0 0-4.44-2.04Z"/></svg>,
                "loader-2": <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg>,
                "check-circle": <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>,
                "circle": <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="10"/></svg>,
                "trash-2": <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>,
                "chevron-right": <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="9 18 15 12 9 6"/></svg>
            };
            return icons[name] || null;
        };

        const GAS_WEB_APP_URL = "https://script.google.com/macros/s/AKfycby6R_xXVII2bE6SnUbD1PLeh7xR9BS27IiIQVZT97kVv7Icm0dsCgI7h9dhDZ1MnVUA/exec".trim();

        function App() {
            const [words, setWords] = useState([]);
            const [view, setView] = useState('list');
            const [loading, setLoading] = useState(false);
            const [isSaving, setIsSaving] = useState(false);
            const [newWord, setNewWord] = useState('');
            const [newMeaning, setNewMeaning] = useState('');
            const [newExample, setNewExample] = useState('');
            const [quizIndex, setQuizIndex] = useState(0);
            const [showAnswer, setShowAnswer] = useState(false);
            const [quizOrder, setQuizOrder] = useState([]);
            const [errorMsg, setErrorMsg] = useState('');

            useEffect(() => {
                fetchWords();
            }, []);

            const fetchWords = async () => {
                if (!GAS_WEB_APP_URL) return;
                setLoading(true);
                setErrorMsg('');
                try {
                    const response = await fetch(GAS_WEB_APP_URL, { cache: 'no-cache' });
                    if (!response.ok) throw new Error('Network response was not ok');
                    const data = await response.json();
                    if (Array.isArray(data)) {
                        data.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                        setWords(data);
                    }
                } catch (error) {
                    console.error("Fetch error:", error);
                    setErrorMsg('データの取得に失敗しました。GASの公開設定を確認してください。');
                } finally {
                    setLoading(false);
                }
            };

            const addWord = async (e) => {
                e.preventDefault();
                if (!newWord || !newMeaning) return;
                setIsSaving(true);
                try {
                    await fetch(GAS_WEB_APP_URL, {
                        method: 'POST',
                        mode: 'no-cors',
                        body: JSON.stringify({
                            action: 'add',
                            word: newWord,
                            meaning: newMeaning,
                            example: newExample,
                            status: 'learning',
                            createdAt: new Date().toISOString()
                        })
                    });
                    setNewWord(''); setNewMeaning(''); setNewExample('');
                    setView('list');
                    setTimeout(fetchWords, 1500);
                } catch (error) {
                    console.error("Save error:", error);
                    alert("保存に失敗しました。");
                } finally {
                    setIsSaving(false);
                }
            };

            const toggleStatus = async (id, currentStatus) => {
                const newStatus = currentStatus === 'learning' ? 'mastered' : 'learning';
                setWords(words.map(w => w.id === id ? {...w, status: newStatus} : w));
                try {
                    await fetch(GAS_WEB_APP_URL, {
                        method: 'POST',
                        mode: 'no-cors',
                        body: JSON.stringify({ action: 'update', id, status: newStatus })
                    });
                } catch (error) { console.error(error); fetchWords(); }
            };

            const deleteWord = async (id) => {
                if (!confirm("削除しますか？")) return;
                setWords(words.filter(w => w.id !== id));
                try {
                    await fetch(GAS_WEB_APP_URL, {
                        method: 'POST',
                        mode: 'no-cors',
                        body: JSON.stringify({ action: 'delete', id })
                    });
                } catch (error) { console.error(error); fetchWords(); }
            };

            const startQuiz = () => {
                if (words.length === 0) return;
                setQuizOrder([...words].sort(() => Math.random() - 0.5));
                setQuizIndex(0); setShowAnswer(false); setView('quiz');
            };

            return (
                <div className="min-h-screen p-4 md:p-8">
                    <div className="max-w-2xl mx-auto">
                        <header className="flex justify-between items-center mb-8">
                            <div>
                                <h1 className="text-3xl font-bold text-indigo-600 italic">VocabSheet</h1>
                                <p className="text-slate-500 text-sm">Spreadsheet App</p>
                            </div>
                            <button onClick={fetchWords} className="p-2 text-slate-400">
                                <Icon name="refresh-cw" className={loading ? "animate-spin" : ""} />
                            </button>
                        </header>

                        {errorMsg && (
                            <div className="bg-red-50 text-red-600 p-3 rounded-xl mb-4 text-sm text-center">
                                {errorMsg}
                            </div>
                        )}

                        <nav className="flex gap-2 mb-6">
                            <button onClick={() => setView('list')} className={`flex-1 py-3 rounded-xl flex items-center justify-center gap-2 ${view === 'list' ? 'bg-indigo-600 text-white shadow-lg' : 'bg-white text-slate-600'}`}>
                                <Icon name="list" className="w-5 h-5" /> 一覧
                            </button>
                            <button onClick={() => setView('add')} className={`flex-1 py-3 rounded-xl flex items-center justify-center gap-2 ${view === 'add' ? 'bg-indigo-600 text-white shadow-lg' : 'bg-white text-slate-600'}`}>
                                <Icon name="plus" className="w-5 h-5" /> 追加
                            </button>
                            <button onClick={startQuiz} className={`flex-1 py-3 rounded-xl flex items-center justify-center gap-2 ${view === 'quiz' ? 'bg-indigo-600 text-white shadow-lg' : 'bg-white text-slate-600'}`}>
                                <Icon name="brain" className="w-5 h-5" /> クイズ
                            </button>
                        </nav>

                        <main>
                            {view === 'list' && (
                                <div className="space-y-4">
                                    {loading ? (
                                        <div className="text-center py-20 flex flex-col items-center gap-2">
                                            <Icon name="loader-2" className="animate-spin text-indigo-500 w-8 h-8" />
                                            <p className="text-slate-400">読み込み中...</p>
                                        </div>
                                    ) : (
                                        words.length === 0 ? (
                                            <div className="text-center py-20 text-slate-400">単語がありません。</div>
                                        ) : (
                                            words.map(item => (
                                                <div key={item.id} className="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 flex items-start justify-between">
                                                    <div className="flex-1 flex gap-3">
                                                        <button onClick={() => toggleStatus(item.id, item.status)}>
                                                            {item.status === 'mastered' ? <Icon name="check-circle" className="text-emerald-500 w-6 h-6" /> : <Icon name="circle" className="text-amber-400 w-6 h-6" />}
                                                        </button>
                                                        <div>
                                                            <h3 className="text-lg font-bold text-slate-700">{item.word}</h3>
                                                            <p className="text-slate-600">{item.meaning}</p>
                                                        </div>
                                                    </div>
                                                    <button onClick={() => deleteWord(item.id)} className="text-slate-300 hover:text-red-500"><Icon name="trash-2" className="w-5 h-5" /></button>
                                                </div>
                                            ))
                                        )
                                    )}
                                </div>
                            )}

                            {view === 'add' && (
                                <form onSubmit={addWord} className="bg-white p-6 rounded-3xl shadow-xl space-y-4">
                                    <input type="text" value={newWord} onChange={e => setNewWord(e.target.value)} className="w-full p-3 border rounded-xl" placeholder="英単語" required />
                                    <input type="text" value={newMeaning} onChange={e => setNewMeaning(e.target.value)} className="w-full p-3 border rounded-xl" placeholder="意味" required />
                                    <textarea value={newExample} onChange={e => setNewExample(e.target.value)} className="w-full p-3 border rounded-xl h-24" placeholder="例文" />
                                    <button type="submit" disabled={isSaving} className="w-full bg-indigo-600 text-white font-bold py-4 rounded-xl shadow-lg flex items-center justify-center gap-2">
                                        {isSaving && <Icon name="loader-2" className="animate-spin w-5 h-5" />}
                                        {isSaving ? "保存中..." : "スプレッドシートに保存"}
                                    </button>
                                </form>
                            )}

                            {view === 'quiz' && quizOrder.length > 0 && (
                                <div className="space-y-6">
                                    <div className="bg-white min-h-[300px] flex flex-col items-center justify-center p-8 rounded-3xl shadow-xl border border-indigo-50">
                                        <h2 className="text-5xl font-black text-slate-800 mb-8">{quizOrder[quizIndex].word}</h2>
                                        {showAnswer ? (
                                            <div className="text-center">
                                                <p className="text-3xl font-bold text-indigo-600">{quizOrder[quizIndex].meaning}</p>
                                            </div>
                                        ) : (
                                            <button onClick={() => setShowAnswer(true)} className="bg-indigo-50 text-indigo-600 px-10 py-4 rounded-full font-bold">答えを確認</button>
                                        )}
                                    </div>
                                    {showAnswer && (
                                        <button onClick={() => {
                                            if (quizIndex < quizOrder.length - 1) { setQuizIndex(quizIndex + 1); setShowAnswer(false); }
                                            else { setView('list'); }
                                        }} className="w-full bg-emerald-500 text-white font-bold py-5 rounded-2xl shadow-lg flex items-center justify-center gap-2">
                                            次へ <Icon name="chevron-right" className="w-6 h-6" />
                                        </button>
                                    )}
                                </div>
                            )}
                        </main>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
