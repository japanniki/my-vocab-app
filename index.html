<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VocabSheet - 英単語帳</title>
    <!-- 必要なライブラリの読み込み -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- アイコンライブラリ -->
    <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body class="bg-slate-50">
    <div id="root"></div>

    <script type="text/babel">
        // LucideアイコンをReactで使えるようにする準備
        const { 
          Plus, Trash2, CheckCircle, Circle, BookOpen, 
          Brain, List, ChevronRight, Save, X, 
          Loader2, RefreshCw, FileSpreadsheet 
        } = {
            Plus: (props) => <i data-lucide="plus" {...props}></i>,
            Trash2: (props) => <i data-lucide="trash-2" {...props}></i>,
            CheckCircle: (props) => <i data-lucide="check-circle" {...props}></i>,
            Circle: (props) => <i data-lucide="circle" {...props}></i>,
            BookOpen: (props) => <i data-lucide="book-open" {...props}></i>,
            Brain: (props) => <i data-lucide="brain" {...props}></i>,
            List: (props) => <i data-lucide="list" {...props}></i>,
            ChevronRight: (props) => <i data-lucide="chevron-right" {...props}></i>,
            Save: (props) => <i data-lucide="save" {...props}></i>,
            X: (props) => <i data-lucide="x" {...props}></i>,
            Loader2: (props) => <i data-lucide="loader-2" {...props}></i>,
            RefreshCw: (props) => <i data-lucide="refresh-cw" {...props}></i>,
            FileSpreadsheet: (props) => <i data-lucide="file-spreadsheet" {...props}></i>
        };

        const { useState, useEffect } = React;

        // URLの末尾に不要なスペースが入らないよう .trim() を追加
        const GAS_WEB_APP_URL = "https://script.google.com/macros/s/AKfycby6R_xXVII2bE6SnUbD1PLeh7xR9BS27IiIQVZT97kVv7Icm0dsCgI7h9dhDZ1MnVUA/exec".trim();

        function App() {
            const [words, setWords] = useState([]);
            const [view, setView] = useState('list');
            const [loading, setLoading] = useState(false);
            const [isSaving, setIsSaving] = useState(false);
            const [newWord, setNewWord] = useState('');
            const [newMeaning, setNewMeaning] = useState('');
            const [newExample, setNewExample] = useState('');
            const [quizIndex, setQuizIndex] = useState(0);
            const [showAnswer, setShowAnswer] = useState(false);
            const [quizOrder, setQuizOrder] = useState([]);
            const [errorMsg, setErrorMsg] = useState('');

            useEffect(() => {
                fetchWords();
            }, []);

            // アイコンを描画するための命令（Lucide用）
            useEffect(() => {
                if (window.lucide) {
                    window.lucide.createIcons();
                }
            });

            const fetchWords = async () => {
                if (!GAS_WEB_APP_URL) return;
                setLoading(true);
                setErrorMsg('');
                try {
                    // cache: 'no-cache' を追加して最新データを取得しやすくする
                    const response = await fetch(GAS_WEB_APP_URL, { cache: 'no-cache' });
                    if (!response.ok) throw new Error('Network response was not ok');
                    const data = await response.json();
                    if (Array.isArray(data)) {
                        data.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                        setWords(data);
                    }
                } catch (error) {
                    console.error("Fetch error:", error);
                    setErrorMsg('データの取得に失敗しました。GASの公開設定を確認してください。');
                } finally {
                    setLoading(false);
                }
            };

            const addWord = async (e) => {
                e.preventDefault();
                if (!newWord || !newMeaning) return;
                setIsSaving(true);
                try {
                    const response = await fetch(GAS_WEB_APP_URL, {
                        method: 'POST',
                        mode: 'no-cors', // CORSエラー対策
                        body: JSON.stringify({
                            action: 'add',
                            word: newWord,
                            meaning: newMeaning,
                            example: newExample,
                            status: 'learning',
                            createdAt: new Date().toISOString()
                        })
                    });
                    setNewWord(''); setNewMeaning(''); setNewExample('');
                    setView('list');
                    // no-cors の場合はレスポンスが読めないため、少し待ってから再取得
                    setTimeout(fetchWords, 1500);
                } catch (error) {
                    console.error("Save error:", error);
                    alert("保存に失敗しました。");
                } finally {
                    setIsSaving(false);
                }
            };

            const toggleStatus = async (id, currentStatus) => {
                const newStatus = currentStatus === 'learning' ? 'mastered' : 'learning';
                setWords(words.map(w => w.id === id ? {...w, status: newStatus} : w));
                try {
                    await fetch(GAS_WEB_APP_URL, {
                        method: 'POST',
                        mode: 'no-cors',
                        body: JSON.stringify({ action: 'update', id, status: newStatus })
                    });
                } catch (error) { console.error(error); fetchWords(); }
            };

            const deleteWord = async (id) => {
                if (!confirm("削除しますか？")) return;
                setWords(words.filter(w => w.id !== id));
                try {
                    await fetch(GAS_WEB_APP_URL, {
                        method: 'POST',
                        mode: 'no-cors',
                        body: JSON.stringify({ action: 'delete', id })
                    });
                } catch (error) { console.error(error); fetchWords(); }
            };

            const startQuiz = () => {
                if (words.length === 0) return;
                setQuizOrder([...words].sort(() => Math.random() - 0.5));
                setQuizIndex(0); setShowAnswer(false); setView('quiz');
            };

            return (
                <div className="min-h-screen p-4 md:p-8">
                    <div className="max-w-2xl mx-auto">
                        <header className="flex justify-between items-center mb-8">
                            <div>
                                <h1 className="text-3xl font-bold text-indigo-600 italic">VocabSheet</h1>
                                <p className="text-slate-500 text-sm">Spreadsheet App</p>
                            </div>
                            <button onClick={fetchWords} className="p-2 text-slate-400">
                                <RefreshCw className={loading ? "animate-spin" : ""} />
                            </button>
                        </header>

                        {errorMsg && (
                            <div className="bg-red-50 text-red-600 p-3 rounded-xl mb-4 text-sm text-center">
                                {errorMsg}
                            </div>
                        )}

                        <nav className="flex gap-2 mb-6">
                            <button onClick={() => setView('list')} className={`flex-1 py-3 rounded-xl flex items-center justify-center gap-2 ${view === 'list' ? 'bg-indigo-600 text-white shadow-lg' : 'bg-white text-slate-600'}`}>
                                <List size={18} /> 一覧
                            </button>
                            <button onClick={() => setView('add')} className={`flex-1 py-3 rounded-xl flex items-center justify-center gap-2 ${view === 'add' ? 'bg-indigo-600 text-white shadow-lg' : 'bg-white text-slate-600'}`}>
                                <Plus size={18} /> 追加
                            </button>
                            <button onClick={startQuiz} className={`flex-1 py-3 rounded-xl flex items-center justify-center gap-2 ${view === 'quiz' ? 'bg-indigo-600 text-white shadow-lg' : 'bg-white text-slate-600'}`}>
                                <Brain size={18} /> クイズ
                            </button>
                        </nav>

                        <main>
                            {view === 'list' && (
                                <div className="space-y-4">
                                    {loading ? (
                                        <div className="text-center py-20 flex flex-col items-center gap-2">
                                            <Loader2 className="animate-spin text-indigo-500" />
                                            <p className="text-slate-400">読み込み中...</p>
                                        </div>
                                    ) : (
                                        words.length === 0 ? (
                                            <div className="text-center py-20 text-slate-400">単語がありません。</div>
                                        ) : (
                                            words.map(item => (
                                                <div key={item.id} className="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 flex items-start justify-between">
                                                    <div className="flex-1 flex gap-3">
                                                        <button onClick={() => toggleStatus(item.id, item.status)}>
                                                            {item.status === 'mastered' ? <CheckCircle className="text-emerald-500" /> : <Circle className="text-amber-400" />}
                                                        </button>
                                                        <div>
                                                            <h3 className="text-lg font-bold text-slate-700">{item.word}</h3>
                                                            <p className="text-slate-600">{item.meaning}</p>
                                                        </div>
                                                    </div>
                                                    <button onClick={() => deleteWord(item.id)} className="text-slate-300 hover:text-red-500"><Trash2 size={18} /></button>
                                                </div>
                                            ))
                                        )
                                    )}
                                </div>
                            )}

                            {view === 'add' && (
                                <form onSubmit={addWord} className="bg-white p-6 rounded-3xl shadow-xl space-y-4">
                                    <input type="text" value={newWord} onChange={e => setNewWord(e.target.value)} className="w-full p-3 border rounded-xl" placeholder="英単語" required />
                                    <input type="text" value={newMeaning} onChange={e => setNewMeaning(e.target.value)} className="w-full p-3 border rounded-xl" placeholder="意味" required />
                                    <textarea value={newExample} onChange={e => setNewExample(e.target.value)} className="w-full p-3 border rounded-xl h-24" placeholder="例文" />
                                    <button type="submit" disabled={isSaving} className="w-full bg-indigo-600 text-white font-bold py-4 rounded-xl shadow-lg flex items-center justify-center gap-2">
                                        {isSaving && <Loader2 className="animate-spin" />}
                                        {isSaving ? "保存中..." : "スプレッドシートに保存"}
                                    </button>
                                </form>
                            )}

                            {view === 'quiz' && quizOrder.length > 0 && (
                                <div className="space-y-6">
                                    <div className="bg-white min-h-[300px] flex flex-col items-center justify-center p-8 rounded-3xl shadow-xl border border-indigo-50">
                                        <h2 className="text-5xl font-black text-slate-800 mb-8">{quizOrder[quizIndex].word}</h2>
                                        {showAnswer ? (
                                            <div className="text-center">
                                                <p className="text-3xl font-bold text-indigo-600">{quizOrder[quizIndex].meaning}</p>
                                            </div>
                                        ) : (
                                            <button onClick={() => setShowAnswer(true)} className="bg-indigo-50 text-indigo-600 px-10 py-4 rounded-full font-bold">答えを確認</button>
                                        )}
                                    </div>
                                    {showAnswer && (
                                        <button onClick={() => {
                                            if (quizIndex < quizOrder.length - 1) { setQuizIndex(quizIndex + 1); setShowAnswer(false); }
                                            else { setView('list'); }
                                        }} className="w-full bg-emerald-500 text-white font-bold py-5 rounded-2xl shadow-lg flex items-center justify-center gap-2">
                                            次へ <ChevronRight />
                                        </button>
                                    )}
                                </div>
                            )}
                        </main>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
